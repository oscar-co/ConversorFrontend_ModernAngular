<div class="container mt-5 pt-5" *ngIf="!cargando; else cargandoTemplate"
     data-comp="editar-patron" data-testid="edit-certificate.container">
  <div class="card shadow" data-testid="edit-certificate.card">
    <div class="card-header bg-dark text-white" data-testid="edit-certificate.header">
      <h4 class="mb-0">Editar Certificado de Calibración</h4>
    </div>
    <div class="card-body" data-testid="edit-certificate.body">
      <form [formGroup]="patronForm" (ngSubmit)="submit()" data-testid="edit-certificate.form" novalidate>

        <input type="hidden" formControlName="id" />

        <!-- Datos generales -->
        <div class="row mb-3">
          <div class="col-md-6" data-testid="field.certificate-number">
            <label class="form-label">Número de certificado</label>
            <input class="form-control" formControlName="certificateNumber" required data-testid="input.certificate-number">
          </div>
          <div class="col-md-6" data-testid="field.type">
            <label class="form-label">Tipo de instrumento</label>
            <input class="form-control" formControlName="insType" required data-testid="input.type">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4" data-testid="field.brand">
            <label class="form-label">Marca</label>
            <input class="form-control" formControlName="brand" data-testid="input.brand">
          </div>
          <div class="col-md-4" data-testid="field.model">
            <label class="form-label">Modelo</label>
            <input class="form-control" formControlName="model" data-testid="input.model">
          </div>
          <div class="col-md-4" data-testid="field.identifier">
            <label class="form-label">Identificación</label>
            <input class="form-control" formControlName="nameIdentify" data-testid="input.identifier">
          </div>
        </div>

        <div class="mb-3" data-testid="field.description">
          <label class="form-label">Descripción</label>
          <textarea class="form-control" formControlName="description" rows="2" data-testid="textarea.description"></textarea>
        </div>

        <div class="row mb-3">
          <div class="col-md-6" data-testid="field.unit">
            <label class="form-label">Unidad de medida</label>
            <input class="form-control" formControlName="unit" data-testid="input.unit">
          </div>
          <div class="col-md-6" data-testid="field.issue-date">
            <label class="form-label">Fecha de emisión</label>
            <input type="date" class="form-control" formControlName="issueDate" data-testid="input.issue-date">
          </div>
        </div>

        <hr />
        <h5 data-testid="measurements.title">Mediciones</h5>

        <!-- Mediciones dinámicas -->
        <div formArrayName="measurements" data-testid="measurements.container">
          <div *ngFor="let m of measurements.controls; let i = index"
               [formGroupName]="i" class="border rounded p-3 mb-3"
               [attr.data-testid]="'measurement.row.' + i">

            <div class="row">
              <input type="hidden" formControlName="id" />
              <div class="col-md-2" data-testid="field.reference">
                <label class="form-label">Referencia</label>
                <input class="form-control" formControlName="reference" data-testid="input.reference">
              </div>
              <div class="col-md-2" data-testid="field.instrumentReading">
                <label class="form-label">Lectura</label>
                <input class="form-control" formControlName="instrumentReading" data-testid="input.instrumentReading">
              </div>
              <div class="col-md-2" data-testid="field.correction">
                <label class="form-label">Corrección</label>
                <input class="form-control" formControlName="correction" data-testid="input.correction">
              </div>
              <div class="col-md-2" data-testid="field.uncertainty">
                <label class="form-label">Incertidumbre</label>
                <input class="form-control" formControlName="uncertainty" data-testid="input.uncertainty">
              </div>
              <div class="col-md-2" data-testid="field.ambientTemp">
                <label class="form-label">Temp. ambiente</label>
                <input class="form-control" formControlName="ambientTemp" data-testid="input.ambientTemp">
              </div>
              <div class="col-md-2 d-flex align-items-end justify-content-center" data-testid="actions.row">
                <button type="button" class="btn btn-danger btn-sm" (click)="removeMeasurement(i)" data-testid="btn.remove-measurement">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mb-4" data-testid="actions.measurements">
          <button type="button" class="btn btn-outline-primary" (click)="addMeasurement()" data-testid="btn.add-measurement">
            <i class="fas fa-plus"></i> Añadir medición
          </button>
        </div>

        <div class="text-end" data-testid="actions.submit">
          <button type="submit" class="btn btn-success me-2" [disabled]="patronForm.invalid" data-testid="btn.save">
            <i class="fas fa-save"></i> Guardar Cambios
          </button>
          <a class="btn btn-secondary" [routerLink]="['/conversor-project/mostrar-patron', patronId]" data-testid="btn.cancel">
            Cancelar
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<ng-template #cargandoTemplate>
  <div class="text-center mt-5 pt-5" data-testid="edit-certificate.loading">
    <div class="spinner-border" role="status" data-testid="loading.spinner"></div>
    <p class="mt-3" data-testid="loading.text">Cargando datos del patrón...</p>
  </div>
</ng-template>
